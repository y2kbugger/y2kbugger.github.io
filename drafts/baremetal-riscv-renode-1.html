<!DOCTYPE html>
<html lang="en">
<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <title>Baremetal RISC-V Renode - Part 1 - y2kbugger</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/theme/css/normalize.css">
        <link rel="stylesheet" href="/theme/css/styles.css">
        <link rel="stylesheet" href="/theme/css/pygment.css">
        
<link rel="icon" href="/favicon.ico" sizes="16x16 32x32 48x48 64x64" type="image/vnd.microsoft.icon">




        <meta name="tags" contents="baremetal"/>
        <meta name="tags" contents="assembly"/>
</head>

<body>

<div id="wrapper">

    <nav>
        <ul id="menu">
                <li><a href="/index.html">y2kbugger</a>
                </li>
                <li><a href="/tags.html">Tags</a>
                </li>
                        <li><a
                                href="http://blog.y2kbugger.com/category/electronics.html">electronics</a></li>
                        <li><a
                                href="http://blog.y2kbugger.com/category/food.html">food</a></li>
                        <li class="active"><a
                                href="http://blog.y2kbugger.com/category/programming.html">programming</a></li>
                        <li><a
                                href="http://blog.y2kbugger.com/category/talks.html">talks</a></li>
        </ul>
    </nav>

    <header class="page-header">
    <h1>Baremetal RISC-V Renode - Part 1</h1>

    <div class="article-meta">
                <span class="author">By zak kohler</span>
        <span class="publication-date" title="2020-05-21T17:48:03-04:00"> on 2020.05.21 @ 17:48</span>
        <span class="modification-date" title="2020-05-21T17:48:03-04:00"> last modified on 2020.05.21 @ 17:48</span>


            <div class="tags">
                Tagged:
                    <a href="http://blog.y2kbugger.com/tag/baremetal.html">baremetal</a>,                    <a href="http://blog.y2kbugger.com/tag/assembly.html">assembly</a>            </div>
    </div>

    </header>

    <main class="content">
    <div class="article-content">
        <!-- Google Photos Album: https://photos.app.goo.gl/LUXeip6Xz85QRTn78
https://www.youtube.com/watch?v=D0VuYe77Wu0&list=PLb-MsRpo_wlLW0EWRpAqnbbDsf4kxSI1x -->
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#background" id="id2">Background</a><ul>
<li><a class="reference internal" href="#why-do-this" id="id3">Why do this</a></li>
<li><a class="reference internal" href="#what-is-baremetal" id="id4">What is baremetal?</a></li>
<li><a class="reference internal" href="#what-is-risc-v" id="id5">What is RISC-V?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#obtain-the-source-code" id="id6">Obtain the source code</a></li>
<li><a class="reference internal" href="#toolchain-compilation" id="id7">Toolchain compilation</a><ul>
<li><a class="reference internal" href="#building" id="id8">Building</a></li>
<li><a class="reference internal" href="#build-requirement-hints" id="id9">Build requirement hints</a><ul>
<li><a class="reference internal" href="#gcc" id="id10">gcc</a></li>
<li><a class="reference internal" href="#renode" id="id11">Renode</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#activating-the-toolchains" id="id12">Activating the toolchains</a></li>
<li><a class="reference internal" href="#blinking-a-virtual-led" id="id13">Blinking a virtual LED</a><ul>
<li><a class="reference internal" href="#what-did-we-just-do" id="id14">What did we just do?</a></li>
<li><a class="reference internal" href="#program-code" id="id15">Program code</a></li>
<li><a class="reference internal" href="#id1" id="id16">renode</a></li>
<li><a class="reference internal" href="#gdb-tui" id="id17">gdb tui</a></li>
</ul>
</li>
<li><a class="reference internal" href="#miro-samek-and-the-modern-embedded-course-series" id="id18">Miro Samek and the modern embedded course series</a></li>
<li><a class="reference internal" href="#preview-of-next-post" id="id19">Preview of next post</a></li>
</ul>
</div>
<div class="section" id="background">
<h2><a class="toc-backref" href="#id2">Background</a></h2>
<div class="section" id="why-do-this">
<h3><a class="toc-backref" href="#id3">Why do this</a></h3>
<p>The goal of this series explore the line between hardware and software while creating a minimal, vendor-free environment to write and play with toy operating systems.</p>
</div>
<div class="section" id="what-is-baremetal">
<h3><a class="toc-backref" href="#id4">What is baremetal?</a></h3>
<p>In the non-embedded world, when you compile and link a C program into an executable you are doing so with the intention of running it <em>within</em> a specific operating system. When you compile baremetal or <tt class="docutils literal"><span class="pre">--freestanding</span></tt> you are telling the compiler that you intend to run this without relying on an operating system. The could be used, for example, to write an operating system. Alternatively it can be used to access the hardware of a system directly on an embedded system. Doing so you sacrifice things such as memory management, standard IO, thread/process control, etc. Because of this, you can also compile to run on a small RTOS or even an embedded linux system depending on the amount of system resources you have available.</p>
<p>When you use a commercial development platform, you will likely be provided with a cross compiling toolchain and so easy way to run within a small RTOS for example <a class="reference external" href="https://github.com/sifive/freedom-e-sdk">freedom-e-sdk</a>. Alternatively, there are also attempts to make small, but hardware agonistic RTOS see <a class="reference external" href="https://www.zephyrproject.org/">zephyr</a></p>
</div>
<div class="section" id="what-is-risc-v">
<h3><a class="toc-backref" href="#id5">What is RISC-V?</a></h3>
<p>Wikipedia</p>
<blockquote>
RISC-V (pronounced &quot;risk-five&quot;) is an open standard instruction set architecture (ISA) based on established reduced instruction set computer (RISC) principles. Unlike most other ISA designs, the RISC-V ISA is provided under open source licenses that do not require fees to use.</blockquote>
</div>
</div>
<div class="section" id="obtain-the-source-code">
<h2><a class="toc-backref" href="#id6">Obtain the source code</a></h2>
<p>To get started you will need to clone the repository. This includes all of the examples as well as the source for Renode simulator and gcc riscv tool chain.</p>
<p>Renode and GCC are git submodules so if you use <tt class="docutils literal"><span class="pre">--recursive</span></tt> you can get everything downloaded in one shot.</p>
<div class="highlight"><pre><span></span>git clone --recursive git@github.com:y2kbugger/baremetal-riscv-renode.git
</pre></div>
</div>
<div class="section" id="toolchain-compilation">
<h2><a class="toc-backref" href="#id7">Toolchain compilation</a></h2>
<p>Technically you could try to find these pre-compiled from your distro or elsewhere, but I suggest compiling from source to ensure we have matching versions and build options.</p>
<p>There are some compilation prerequisites and gotchas. If my package hints fail, just refer to the official project documentation for each.</p>
<div class="section" id="building">
<h3><a class="toc-backref" href="#id8">Building</a></h3>
<p>I have added a <tt class="docutils literal">Makefile</tt> which build the toolchains. If you have all of the build requirements already installed, building both can be as simple as:</p>
<div class="highlight"><pre><span></span><span class="nb">cd</span> baremetal-riskv-renode
make toolchains
</pre></div>
<p>Running it should usually be enough to let you know what you are missing. I have included some hints below, check the comments as well as different platforms may have different packages.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p>Make sure you have <tt class="docutils literal">curses</tt>/<tt class="docutils literal">ncurses</tt> headers.</p>
<p class="last">If they are missing the build will <strong>succeed</strong>, but you will <strong>not be able to access</strong> the GDB text user interface, TUI. This is import for being able to step through the source code. See the GCC hints.</p>
</div>
</div>
<div class="section" id="build-requirement-hints">
<h3><a class="toc-backref" href="#id9">Build requirement hints</a></h3>
<p>Below are my hints for which packages to install, this can be different depending on the distribution. I've include links to the official guides should you get stuck on either.</p>
<div class="section" id="gcc">
<h4><a class="toc-backref" href="#id10">gcc</a></h4>
<p><a class="reference external" href="https://github.com/riscv/riscv-gnu-toolchain">https://github.com/riscv/riscv-gnu-toolchain</a></p>
<pre class="code literal-block">
gawk texinfo bison flex libncurses5-dev libncursesw5-dev
</pre>
<p>The package <tt class="docutils literal">libncurses*</tt> provides <tt class="docutils literal">ncurses</tt>, and  <tt class="docutils literal">texinfo</tt> provides <tt class="docutils literal">makeinfo</tt>.</p>
</div>
<div class="section" id="renode">
<h4><a class="toc-backref" href="#id11">Renode</a></h4>
<p><a class="reference external" href="https://renode.readthedocs.io/en/latest/advanced/building_from_sources.html">https://renode.readthedocs.io/en/latest/advanced/building_from_sources.html</a></p>
<p>Mono provides CLR runtime and C# compiler required for Renode. Installing it can be tricky on some distros and having a mono that is incomplete or outdated can lead to hard-to-understand errors. Make sure your whole system is up-to-date if you run into issue compiling Renode.</p>
<dl class="docutils">
<dt>Arch</dt>
<dd>Everything worked fine using the <tt class="docutils literal">mono</tt> package from extra.</dd>
<dt>Ubuntu</dt>
<dd><strong>Do not</strong> use the mono from standard repos. Follow instruction for <tt class="docutils literal"><span class="pre">mono-complete</span></tt> here <a class="reference external" href="https://www.mono-project.com/download/stable/">https://www.mono-project.com/download/stable/</a>.</dd>
</dl>
<pre class="code literal-block">
automake autoconf libtool g++ coreutils policykit-1 libgtk2.0-dev screen uml-utilities gtk-sharp2 python3
</pre>
<p>The package <tt class="docutils literal">coreutils</tt> provides <tt class="docutils literal">realpath</tt> on Debian.</p>
</div>
</div>
</div>
<div class="section" id="activating-the-toolchains">
<h2><a class="toc-backref" href="#id12">Activating the toolchains</a></h2>
<p>In order to run renode and gdb, you must put them on your <tt class="docutils literal">PATH</tt>.</p>
<div class="highlight"><pre><span></span><span class="nb">source</span> activate_toolchains.sh
</pre></div>
</div>
<div class="section" id="blinking-a-virtual-led">
<h2><a class="toc-backref" href="#id13">Blinking a virtual LED</a></h2>
<p>This is the part where we see whether the toolchains are compiled correctly.</p>
<p>We will learn how to control Renode and band step through the source code using the GNU debugger, <tt class="docutils literal">gdb</tt>.</p>
<p>Since we are just getting familiar with the tools we'll start off with the 'Hello, World' of hardware projects, blinking an LED.</p>
<p>To build and run our first example within Renode:</p>
<div class="highlight"><pre><span></span><span class="nb">cd</span> 1_blinky
make launch
</pre></div>
<p>If everything went correctly, you should see something like this:</p>
<img alt="" src="https://lh3.googleusercontent.com/pw/ACtC-3dKs20yaz1biM2MWXyi7HAcI0pb-BHYDYD1XM92Al11dQPQ26OJY8YULAlHPHtduGETCN5Y5D6aXtkiFi3-9tB3RNtj4A687SGo765evyqri2TjKMCyQeNSLNfZ-SV52yXlIEar9iQj2aEzPKAmBGrQOA=w628-h449-no" />
<ul class="simple">
<li>todo explain make monitor open monitor and type quit to shutdown renode.</li>
</ul>
<div class="section" id="what-did-we-just-do">
<h3><a class="toc-backref" href="#id14">What did we just do?</a></h3>
<p>The first thing that happened is that we built our image that will be loaded into Renode. You can think of the image like a ROM and Renode is the emulator.</p>
<div class="highlight"><pre><span></span>riscv32-unknown-elf-gcc baremetal.s baremetal.c -ggdb -O0 -o image -ffreestanding -nostdlib
</pre></div>
<dl class="docutils">
<dt>riscv32-unknown-elf-gcc</dt>
<dd>gnu compiler. This will compile, assemble any link source code. This is the special cross compiling variant that we built earlier which runs on you host architecture (e.g. x86), but outputs binaries for riscv32.</dd>
<dt>baremetal.s baremetal.c</dt>
<dd>adsf</dd>
</dl>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group">
<kbd><span class="option">-g<var>gdb</var></span></kbd></td>
<td>Turn on debugging symbols so that gdb can reference memory locations by name.</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-O</span></kbd></td>
<td>Sets the optimization level, 0 for off</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-o <var>image</var></span></kbd></td>
<td>Name of the output ELF binary</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-f<var>freestanding</var></span></kbd></td>
<td>don't use or require main. Don't assume we have an operating system.</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-n<var>ostdlib</var></span></kbd></td>
<td>don't rely on c standard libraries being available.</td></tr>
</tbody>
</table>
</div>
<div class="section" id="program-code">
<h3><a class="toc-backref" href="#id15">Program code</a></h3>
<div class="highlight"><pre><span></span><span class="na">.equ</span> <span class="no">LED</span><span class="p">,</span> <span class="mi">0x60000800</span>

<span class="na">.section</span> <span class="no">.text</span>
<span class="na">.global</span> <span class="no">_start</span>

<span class="nl">_start:</span>
        <span class="nf">li</span> <span class="no">a0</span><span class="p">,</span> <span class="mi">0x00</span>
        <span class="nf">li</span> <span class="no">a0</span><span class="p">,</span> <span class="mi">0x00</span>
        <span class="nf">li</span> <span class="no">a3</span><span class="p">,</span> <span class="mi">0x1200000</span>
        <span class="nf">li</span> <span class="no">a5</span><span class="p">,</span> <span class="no">LED</span>
<span class="nl">loop:</span>
        <span class="nf">addi</span> <span class="no">a0</span><span class="p">,</span> <span class="no">a0</span><span class="p">,</span> <span class="mi">0x01</span>
        <span class="nf">bne</span> <span class="no">a0</span><span class="p">,</span> <span class="no">a3</span><span class="p">,</span>  <span class="no">loop</span>

<span class="nl">toggle_led:</span>
        <span class="nf">lw</span> <span class="no">a4</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">(</span><span class="no">a5</span><span class="p">)</span>
        <span class="nf">xori</span> <span class="no">a4</span><span class="p">,</span> <span class="no">a4</span><span class="p">,</span> <span class="mi">0x1</span>
        <span class="nf">sw</span> <span class="no">a4</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">(</span><span class="no">a5</span><span class="p">)</span>
        <span class="nf">jump</span> <span class="no">_start</span><span class="p">,</span> <span class="no">t0</span>
</pre></div>
<ul class="simple">
<li>explain reset vector TODO</li>
<li>explain memory mapped hardware registers.</li>
</ul>
</div>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id16">renode</a></h3>
<ul class="simple">
<li>todo explain how we launched Renode</li>
<li>explain reset vector TODO againg? for first time here instead?</li>
<li>explain the platform and and command files for renode.</li>
</ul>
</div>
<div class="section" id="gdb-tui">
<h3><a class="toc-backref" href="#id17">gdb tui</a></h3>
<ul class="simple">
<li>todo explain:</li>
<li>how to step through code</li>
<li>now to set breakpoint</li>
<li>how to continue</li>
<li>inspecting registers</li>
</ul>
<img alt="" src="https://lh3.googleusercontent.com/pw/ACtC-3eVGqrh2Gm1lQJKH27cWNYUQO8fVTUAvM1FNZ_pUis0Upip6vEa4ZNGOh79vosxGnBtFcacVX8QRNDgKEeklwFnI9hs6WrAlnzpTDZIyyn1oyTclXxU4_IlzydFbb0UFDkm0CFMsU8f3KIEKY0OWxoPzQ=w354-h710-no" />
</div>
</div>
<div class="section" id="miro-samek-and-the-modern-embedded-course-series">
<h2><a class="toc-backref" href="#id18">Miro Samek and the modern embedded course series</a></h2>
<p>I will be loosing cloning MIROS following some of his videos in spirit. He does a great introduction to many concepts in embedded and I want to share that in a way that we don't need to have a real board.</p>
</div>
<div class="section" id="preview-of-next-post">
<h2><a class="toc-backref" href="#id19">Preview of next post</a></h2>
</div>

    </div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'blog-y2kbugger'; // required: replace example with your forum shortname
        var disqus_identifier = 'drafts/baremetal-riscv-renode-1.html';
        var disqus_url = 'http://blog.y2kbugger.com/drafts/baremetal-riscv-renode-1.html';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </main>

    <footer class="page-footer">
            zak kohler 2020 &mdash; Happy Hacking
    </footer>

</div>
</body>

<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

 -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-111274102-1', 'auto');
  ga('send', 'pageview');
</script>

</html>