<!DOCTYPE html>
<html lang="en">
<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <title>Baremetal RISC-V Renode - Part 1: Blinky - y2kbugger</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/theme/css/normalize.css">
        <link rel="stylesheet" href="/theme/css/styles.css">
        <link rel="stylesheet" href="/theme/css/pygment.css">
        
<link rel="icon" href="/favicon.ico" sizes="16x16 32x32 48x48 64x64" type="image/vnd.microsoft.icon">




        <meta name="tags" contents="baremetal"/>
        <meta name="tags" contents="assembly"/>
</head>

<body>

<div id="wrapper">

    <nav>
        <ul id="menu">
                <li><a href="/index.html">y2kbugger</a>
                </li>
                <li><a href="/tags.html">Tags</a>
                </li>
                        <li><a
                                href="http://blog.y2kbugger.com/category/electronics.html">electronics</a></li>
                        <li><a
                                href="http://blog.y2kbugger.com/category/food.html">food</a></li>
                        <li class="active"><a
                                href="http://blog.y2kbugger.com/category/programming.html">programming</a></li>
                        <li><a
                                href="http://blog.y2kbugger.com/category/talks.html">talks</a></li>
        </ul>
    </nav>

    <header class="page-header">
    <h1>Baremetal RISC-V Renode - Part 1: Blinky</h1>

    <div class="article-meta">
                <span class="author">By zak kohler</span>
        <span class="publication-date" title="2020-05-21T17:48:03-04:00"> on 2020.05.21 @ 17:48</span>
        <span class="modification-date" title="2020-05-21T17:48:03-04:00"> last modified on 2020.05.21 @ 17:48</span>


            <div class="tags">
                Tagged:
                    <a href="http://blog.y2kbugger.com/tag/baremetal.html">baremetal</a>,                    <a href="http://blog.y2kbugger.com/tag/assembly.html">assembly</a>            </div>
    </div>

    </header>

    <main class="content">
    <div class="article-content">
        <!-- Google Photos Album: https://photos.app.goo.gl/LUXeip6Xz85QRTn78
https://www.youtube.com/watch?v=D0VuYe77Wu0&list=PLb-MsRpo_wlLW0EWRpAqnbbDsf4kxSI1x -->
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#background" id="id4">Background</a><ul>
<li><a class="reference internal" href="#what-is-baremetal" id="id5">What is baremetal?</a></li>
<li><a class="reference internal" href="#what-is-risc-v" id="id6">What is RISC-V?</a></li>
<li><a class="reference internal" href="#what-is-renode" id="id7">What is Renode?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#source-code" id="id8">Source code</a></li>
<li><a class="reference internal" href="#toolchain-compilation" id="id9">Toolchain compilation</a><ul>
<li><a class="reference internal" href="#building" id="id10">Building</a></li>
<li><a class="reference internal" href="#build-requirement-hints" id="id11">Build requirement hints</a></li>
</ul>
</li>
<li><a class="reference internal" href="#activating-the-toolchains" id="id12">Activating the toolchains</a></li>
<li><a class="reference internal" href="#blinking-a-virtual-led" id="id13">Blinking a virtual LED</a><ul>
<li><a class="reference internal" href="#just-get-it-running" id="id14">Just get it running</a></li>
<li><a class="reference internal" href="#hardware-configuration" id="id15">Hardware configuration</a></li>
<li><a class="reference internal" href="#blinky-source-code" id="id16">Blinky source code</a></li>
<li><a class="reference internal" href="#building-an-elf-binary-using-gcc" id="id17">Building an elf binary using gcc</a></li>
</ul>
</li>
<li><a class="reference internal" href="#miro-samek-and-the-modern-embedded-course-series" id="id18">Miro Samek and the modern embedded course series</a></li>
<li><a class="reference internal" href="#preview-of-next-post" id="id19">Preview of next post</a></li>
</ul>
</div>
<div class="section" id="background">
<h2><a class="toc-backref" href="#id4">Background</a></h2>
<p>I'm exploring the line between hardware and software by creating a minimal, vendor-free environment to write and play with toy operating systems.</p>
<div class="section" id="what-is-baremetal">
<h3><a class="toc-backref" href="#id5">What is baremetal?</a></h3>
<p>In the non-embedded world, when you compile and link a C program into an executable you are doing so with the intention of running it <em>within</em> a specific operating system. When you compile baremetal or <tt class="docutils literal"><span class="pre">-freestanding</span></tt> you are telling the compiler that you intend to run this without relying on an operating system. This could be used, for example, to write an operating system. Alternatively it can be used to access the hardware of a system directly on an embedded system. Doing so sacrifices higher level luxuries such as memory management, standard IO, thread/process control, etc. Because of this, sometimes it makes sense to run on a type of minimal OS optimized for embedded, e.g. a real time operating system or RTOS.</p>
<p>When you use a commercial development platform, you will likely be provided with a cross compiling toolchain and possibly an RTOS. For an example see <a class="reference external" href="https://github.com/sifive/freedom-e-sdk">freedom-e-sdk</a>. Alternatively, there are also attempts to make small, but hardware agonistic RTOS see <a class="reference external" href="https://www.zephyrproject.org/">zephyr</a>.</p>
</div>
<div class="section" id="what-is-risc-v">
<h3><a class="toc-backref" href="#id6">What is RISC-V?</a></h3>
<p>RISV-V is an open alternative to ARM or x86.</p>
<p>Wikipedia</p>
<blockquote>
RISC-V (pronounced &quot;risk-five&quot;) is an open standard instruction set architecture (ISA) based on established reduced instruction set computer (RISC) principles. Unlike most other ISA designs, the RISC-V ISA is provided under open source licenses that do not require fees to use.</blockquote>
</div>
<div class="section" id="what-is-renode">
<h3><a class="toc-backref" href="#id7">What is Renode?</a></h3>
<p>Renode is a simulator designed for embedded firmware. What sets it apart is the goal of not only emulating CPUs and SOCs, but also entire boards with peripherals such as ethernet and even multi-node networks of devices.</p>
<p>Alternatives such as QEMU aren't as optimized for the embedded space.</p>
<p>An emulator that you might use for playing video game ROMs is specialized for a single platform. For example, in an emulator cpu, graphics chips, audio, memory-map, etc are fixed and optimized. Renode on the other hand configures each platform with a config file.</p>
</div>
</div>
<div class="section" id="source-code">
<h2><a class="toc-backref" href="#id8">Source code</a></h2>
<p>To get started you will need to clone the repository. This includes all of the examples as well as the source for Renode simulator and GCC RISC-V toolchain.</p>
<p>Renode and GCC are linked via <tt class="docutils literal">git submodule</tt> so if you use <tt class="docutils literal"><span class="pre">--recursive</span></tt> you can clone everything in one shot.</p>
<div class="highlight"><pre><span></span>git clone --recursive git@github.com:y2kbugger/baremetal-riscv-renode.git
</pre></div>
</div>
<div class="section" id="toolchain-compilation">
<h2><a class="toc-backref" href="#id9">Toolchain compilation</a></h2>
<p>Technically you could try to find these pre-compiled from your distro or elsewhere, but I suggest compiling from source to ensure we have matching versions and build options.</p>
<p>There are some compilation prerequisites and gotchas. If my hints don't help, just refer to the official project documentation for each.</p>
<div class="section" id="building">
<h3><a class="toc-backref" href="#id10">Building</a></h3>
<p>To easy the burden on my own memory, I have added a <tt class="docutils literal">Makefile</tt> to capture the various build options for the toolchains. If you have all of the build requirements already installed, building both can be as simple as:</p>
<div class="highlight"><pre><span></span>$ <span class="nb">cd</span> baremetal-riskv-renode
$ make toolchains
</pre></div>
<p>Running <tt class="docutils literal">make toolchains</tt> should usually be enough to let you know what you are missing. I have included some hints below, check the comments as well as different platforms may have different packages.</p>
</div>
<div class="section" id="build-requirement-hints">
<h3><a class="toc-backref" href="#id11">Build requirement hints</a></h3>
<p>Below are my hints for which packages to install, this can be different depending on the distribution. I've include links to the official guides for getting unstuck.</p>
<div class="section" id="gcc">
<h4>gcc</h4>
<p><a class="reference external" href="https://github.com/riscv/riscv-gnu-toolchain">https://github.com/riscv/riscv-gnu-toolchain</a></p>
<pre class="code literal-block">
gawk texinfo bison flex libncurses5-dev libncursesw5-dev
</pre>
<p>The package <tt class="docutils literal"><span class="pre">libncurses5-dev*</span></tt> provides headers for <tt class="docutils literal">ncurses</tt>, and  <tt class="docutils literal">texinfo</tt> provides <tt class="docutils literal">makeinfo</tt>.</p>
</div>
<div class="section" id="renode">
<h4>Renode</h4>
<p><a class="reference external" href="https://renode.readthedocs.io/en/latest/advanced/building_from_sources.html">https://renode.readthedocs.io/en/latest/advanced/building_from_sources.html</a></p>
<p>Mono provides CLR runtime and C# compiler required for Renode. Installing it can be tricky on some distros and having a mono that is incomplete or outdated can lead to hard-to-understand errors. Make sure your whole system is up-to-date if you run into issue compiling Renode.</p>
<dl class="docutils">
<dt>Arch</dt>
<dd>Everything worked fine using the <tt class="docutils literal">mono</tt> package from extra.</dd>
<dt>Ubuntu</dt>
<dd><strong>Do not</strong> use the mono from standard repos. Follow instruction for <tt class="docutils literal"><span class="pre">mono-complete</span></tt> here <a class="reference external" href="https://www.mono-project.com/download/stable/">https://www.mono-project.com/download/stable/</a>.</dd>
</dl>
<pre class="code literal-block">
automake autoconf libtool g++ coreutils policykit-1 libgtk2.0-dev screen uml-utilities gtk-sharp2 python3
</pre>
<p>The package <tt class="docutils literal">coreutils</tt> provides <tt class="docutils literal">realpath</tt> on Debian.</p>
</div>
</div>
</div>
<div class="section" id="activating-the-toolchains">
<h2><a class="toc-backref" href="#id12">Activating the toolchains</a></h2>
<p>This guide assumes both renode and riscv-gcc are on your <tt class="docutils literal">PATH</tt>.</p>
<div class="highlight"><pre><span></span>$ <span class="nb">source</span> activate-toolchains.sh
</pre></div>
</div>
<div class="section" id="blinking-a-virtual-led">
<h2><a class="toc-backref" href="#id13">Blinking a virtual LED</a></h2>
<p>To verify and get familiar with the tools we'll start off with the 'Hello, World' of hardware projects: blinking an LED.</p>
<p>Blinking a virtual &quot;LED&quot; involves a few steps:</p>
<ol class="arabic simple">
<li>Build <strong>image</strong> from source code</li>
<li>Launch the hardware <strong>simulator</strong> configured by the platform (repl) file</li>
<li>Load the image into <strong>RAM</strong> of the simulator</li>
</ol>
<div class="section" id="just-get-it-running">
<h3><a class="toc-backref" href="#id14">Just get it running</a></h3>
<p>First open up the project folder:</p>
<pre class="literal-block">
$ cd 1_blinky
</pre>
<p>Then following command will handle all steps 1-3, we'll break this down later:</p>
<pre class="literal-block">
$ make launch
</pre>
<p>If everything went correctly, you should see something like this:</p>
<img alt="blinky demo running" src="https://lh3.googleusercontent.com/pw/ACtC-3dKs20yaz1biM2MWXyi7HAcI0pb-BHYDYD1XM92Al11dQPQ26OJY8YULAlHPHtduGETCN5Y5D6aXtkiFi3-9tB3RNtj4A687SGo765evyqri2TjKMCyQeNSLNfZ-SV52yXlIEar9iQj2aEzPKAmBGrQOA=w628-h449-no" />
<p>You should have also noticed the monitor window open up. This is used to control the running renode machine; <tt class="docutils literal">?</tt> will show a list of what commands are available. The tab completion is also very helpful.</p>
<p>Quit using <tt class="docutils literal">q</tt> or <tt class="docutils literal">quit</tt>:</p>
<pre class="literal-block">
(vexriscv-machine) quit
</pre>
<p>Alternatively you can <tt class="docutils literal"><span class="pre">ctrl-c</span></tt> in the original terminal window kill renode.</p>
<img alt="renode quitting" src="https://lh3.googleusercontent.com/pw/ACtC-3fnOWf9q-DJAwfFMefjlX6-CqAgGpGfDzBTi36NOuASben_jmeDlka0AlgziFE5yXRDwnwLE16sFeVXKcKaIfjMaLDhFeLXYv9baJi8OI7C5Hhk35XOuAY78VAZiGmhAJT7GSi0ItsGKk1oQSAnoWN6Tg=w318-h92-no" />
</div>
<div class="section" id="hardware-configuration">
<h3><a class="toc-backref" href="#id15">Hardware configuration</a></h3>
<p>The hardware that will be simulated is defined in the using a renode specific platform description format <a class="footnote-reference" href="#renode-describing-platforms" id="id1">[2]</a></p>
<p>vexriscv.repl:</p>
<pre class="literal-block">
mem: Memory.MappedMemory &#64; sysbus 0x0
    size: 0x00040000

cpu: CPU.VexRiscv &#64; sysbus

gpio_out: GPIOPort.LiteX_GPIO &#64; sysbus 0x60000800
    type: Type.Out
    0 -&gt; led0&#64;0
    1 -&gt; led1&#64;0

led0 : Miscellaneous.LED &#64; gpio_out 0
led1 : Miscellaneous.LED &#64; gpio_out 1
</pre>
<p>I like this because we can make a very minimal hardware configuration, free from any vendor specific complexity. Besides the cpu and memory, we have a GPIO register mapped to memory location <tt class="docutils literal">0x60000800</tt>. The <tt class="docutils literal"><span class="pre">-&gt;</span></tt> makes a connection from the GPIO pins to the LEDs. I don't exactly know why we need both <tt class="docutils literal">0 <span class="pre">-&gt;</span> led0&#64;0</tt> and <tt class="docutils literal">&#64; gpio_out 0</tt> as it seems redundant. <tt class="docutils literal"><span class="pre">-&gt;</span></tt> is used more commonly for connecting interrupts.</p>
<p>To toggle the LED we will need to write a driver that knows how to control the GPIO by writing to it's register.</p>
</div>
<div class="section" id="blinky-source-code">
<h3><a class="toc-backref" href="#id16">Blinky source code</a></h3>
<p>This initial program is written exclusively in risc-v assemble <a class="footnote-reference" href="#riscv-prgrammers-guide" id="id2">[3]</a> this is simple enough that every instruction that gets executed can be traced to this source file.</p>
<p>The code to drive this GPIO device is dead simple, You just need to write a data to the memory location that maps to the GPIO pins.</p>
<p>Note that the platform specifies that the GPIO register is mapped to memory location <tt class="docutils literal">0x60000800</tt></p>
<p>baremetal.s:</p>
<div class="highlight"><pre><span></span><span class="na">.equ</span> <span class="no">LED</span><span class="p">,</span> <span class="mi">0x60000800</span>
<span class="na">.equ</span> <span class="no">DELAY_COUNT</span><span class="p">,</span> <span class="mi">9000000</span>

<span class="na">.section</span> <span class="no">.text</span>
<span class="na">.global</span> <span class="no">_start</span>
<span class="nl">_start:</span>
        <span class="nf">li</span> <span class="no">a5</span><span class="p">,</span> <span class="no">LED</span>
<span class="nl">loop:</span>
        <span class="nf">li</span> <span class="no">a0</span><span class="p">,</span> <span class="no">DELAY_COUNT</span>      <span class="c1"># reset counter</span>
<span class="nl">delay_loop:</span>
        <span class="nf">addi</span> <span class="no">a0</span><span class="p">,</span> <span class="no">a0</span><span class="p">,</span> <span class="p">-</span><span class="mi">1</span>         <span class="c1"># count down</span>
        <span class="nf">bnez</span> <span class="no">a0</span><span class="p">,</span> <span class="no">delay_loop</span>
<span class="nl">toggle_led:</span>
        <span class="nf">lw</span> <span class="no">a4</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">(</span><span class="no">a5</span><span class="p">)</span>          <span class="c1"># read in old led state</span>
        <span class="nf">xori</span> <span class="no">a4</span><span class="p">,</span> <span class="no">a4</span><span class="p">,</span> <span class="mi">0</span><span class="no">b01</span>       <span class="c1"># toggle led state word</span>
        <span class="nf">sw</span> <span class="no">a4</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">(</span><span class="no">a5</span><span class="p">)</span>          <span class="c1"># write new state</span>
        <span class="nf">jump</span> <span class="no">loop</span><span class="p">,</span> <span class="no">t0</span>
</pre></div>
<ul class="simple">
<li>todo which approach?? both? breakpoint and continue, or edit register;</li>
<li>todo teach howoto stop through program using gdb. explain the need to lower the delay_count (you can do it in situ via register hack)</li>
<li>todo inspecting registers</li>
<li>todo how to step through code</li>
<li>todo now to set breakpoint</li>
<li>todo how to continue</li>
<li>todo change led mask in situ?</li>
</ul>
</div>
<div class="section" id="building-an-elf-binary-using-gcc">
<h3><a class="toc-backref" href="#id17">Building an elf binary using gcc</a></h3>
<p>GCC will build am image based on our assembly source code. In video game terms, the image like a ROM and Renode is the emulator.</p>
<p>By default, gcc outputs a format called ELF. This format is understood and loaded by the OS, <a class="reference external" href="https://lwn.net/Articles/631631/">i.e. linux,</a>. Renode also has the ability to understand ELF files and will load the sections into memory and put the program counter at the right spot to start executing <a class="footnote-reference" href="#renode-machine" id="id3">[1]</a>.</p>
<ul class="simple">
<li>explain reset vector TODO</li>
</ul>
<div class="highlight"><pre><span></span>riscv32-unknown-elf-gcc baremetal.s baremetal.c -ggdb -O0 -o image -ffreestanding -nostdlib
</pre></div>
<dl class="docutils">
<dt>riscv32-unknown-elf-gcc</dt>
<dd>gnu compiler. This will compile, assemble any link source code. This is the special cross compiling variant that we built earlier which runs on you host architecture (e.g. x86), but outputs binaries for riscv32.</dd>
<dt>baremetal.s</dt>
<dd>Assemble source file.</dd>
</dl>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group">
<kbd><span class="option">-g<var>gdb</var></span></kbd></td>
<td>Turn on debugging symbols so that gdb can reference memory locations by name.</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-O</span></kbd></td>
<td>Sets the optimization level, 0 for off</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-o <var>image</var></span></kbd></td>
<td>Name of the output ELF binary</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-f<var>freestanding</var></span></kbd></td>
<td>don't use or require main. Don't assume we have an operating system.</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-n<var>ostdlib</var></span></kbd></td>
<td>don't rely on c standard libraries being available.</td></tr>
</tbody>
</table>
<div class="figure align-left">
<img alt="gdb tui" src="https://lh3.googleusercontent.com/pw/ACtC-3eVGqrh2Gm1lQJKH27cWNYUQO8fVTUAvM1FNZ_pUis0Upip6vEa4ZNGOh79vosxGnBtFcacVX8QRNDgKEeklwFnI9hs6WrAlnzpTDZIyyn1oyTclXxU4_IlzydFbb0UFDkm0CFMsU8f3KIEKY0OWxoPzQ=w354-h710-no" />
<p class="caption">This is a caption</p>
</div>
</div>
</div>
<div class="section" id="miro-samek-and-the-modern-embedded-course-series">
<h2><a class="toc-backref" href="#id18">Miro Samek and the modern embedded course series</a></h2>
<p>I will be loosing cloning MIROS following some of his videos in spirit. He does a great introduction to many concepts in embedded and I want to share that in a way that we don't need to have a real board.</p>
</div>
<div class="section" id="preview-of-next-post">
<h2><a class="toc-backref" href="#id19">Preview of next post</a></h2>
<table class="docutils footnote" frame="void" id="renode-machine" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[1]</a></td><td><a class="reference external" href="https://renode.readthedocs.io/en/latest/basic/machines.html">https://renode.readthedocs.io/en/latest/basic/machines.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="renode-describing-platforms" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[2]</a></td><td><a class="reference external" href="https://renode.readthedocs.io/en/latest/basic/describing_platforms.html">https://renode.readthedocs.io/en/latest/basic/describing_platforms.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="riscv-prgrammers-guide" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[3]</a></td><td><a class="reference external" href="https://github.com/riscv/riscv-asm-manual/blob/master/riscv-asm.md">https://github.com/riscv/riscv-asm-manual/blob/master/riscv-asm.md</a></td></tr>
</tbody>
</table>
</div>

    </div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'blog-y2kbugger'; // required: replace example with your forum shortname
        var disqus_identifier = 'drafts/baremetal-riscv-renode-1.html';
        var disqus_url = 'http://blog.y2kbugger.com/drafts/baremetal-riscv-renode-1.html';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </main>

    <footer class="page-footer">
            zak kohler 2020 &mdash; Happy Hacking
    </footer>

</div>
</body>

<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

 -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-111274102-1', 'auto');
  ga('send', 'pageview');
</script>

</html>