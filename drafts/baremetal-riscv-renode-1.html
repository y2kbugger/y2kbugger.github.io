<!DOCTYPE html>
<html lang="en">
<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <title>Baremetal RISC-V Renode - Part 1 - y2kbugger</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/theme/css/normalize.css">
        <link rel="stylesheet" href="/theme/css/styles.css">
        <link rel="stylesheet" href="/theme/css/pygment.css">
        
<link rel="icon" href="/favicon.ico" sizes="16x16 32x32 48x48 64x64" type="image/vnd.microsoft.icon">




        <meta name="tags" contents="baremetal"/>
        <meta name="tags" contents="assembly"/>
</head>

<body>

<div id="wrapper">

    <nav>
        <ul id="menu">
                <li><a href="/index.html">y2kbugger</a>
                </li>
                <li><a href="/tags.html">Tags</a>
                </li>
                        <li><a
                                href="http://blog.y2kbugger.com/category/electronics.html">electronics</a></li>
                        <li><a
                                href="http://blog.y2kbugger.com/category/food.html">food</a></li>
                        <li class="active"><a
                                href="http://blog.y2kbugger.com/category/programming.html">programming</a></li>
                        <li><a
                                href="http://blog.y2kbugger.com/category/talks.html">talks</a></li>
        </ul>
    </nav>

    <header class="page-header">
    <h1>Baremetal RISC-V Renode - Part 1</h1>

    <div class="article-meta">
                <span class="author">By zak kohler</span>
        <span class="publication-date" title="2020-05-21T17:48:03-04:00"> on 2020.05.21 @ 17:48</span>
        <span class="modification-date" title="2020-05-21T17:48:03-04:00"> last modified on 2020.05.21 @ 17:48</span>


            <div class="tags">
                Tagged:
                    <a href="http://blog.y2kbugger.com/tag/baremetal.html">baremetal</a>,                    <a href="http://blog.y2kbugger.com/tag/assembly.html">assembly</a>            </div>
    </div>

    </header>

    <main class="content">
    <div class="article-content">
        <!-- Google Photos Album: https://photos.app.goo.gl/LUXeip6Xz85QRTn78
https://www.youtube.com/watch?v=D0VuYe77Wu0&list=PLb-MsRpo_wlLW0EWRpAqnbbDsf4kxSI1x -->
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#background" id="id1">Background</a><ul>
<li><a class="reference internal" href="#why-do-this" id="id2">Why do this</a></li>
<li><a class="reference internal" href="#what-is-baremetal" id="id3">What is baremetal?</a></li>
<li><a class="reference internal" href="#what-is-risc-v" id="id4">What is RISC-V?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#toolchain-setup" id="id5">Toolchain setup</a><ul>
<li><a class="reference internal" href="#gcc" id="id6">gcc</a></li>
<li><a class="reference internal" href="#renode" id="id7">renode</a></li>
</ul>
</li>
<li><a class="reference internal" href="#blinking-the-virtual-led" id="id8">Blinking the virtual led</a></li>
<li><a class="reference internal" href="#miro-samek-and-the-modern-embedded-course-series" id="id9">Miro Samek and the modern embedded course series</a></li>
</ul>
</div>
<div class="section" id="background">
<h2><a class="toc-backref" href="#id1">Background</a></h2>
<div class="section" id="why-do-this">
<h3><a class="toc-backref" href="#id2">Why do this</a></h3>
<p>The goal of this series explore the line between hardware and software while creating a minimal, vendor-free environment to play with toy operating systems.</p>
</div>
<div class="section" id="what-is-baremetal">
<h3><a class="toc-backref" href="#id3">What is baremetal?</a></h3>
<p>In the non-embedded world, when you compile and link a C program into an executable you are doing so with the intention of running it <em>within</em> a specific operating system. When you compile baremetal or <tt class="docutils literal"><span class="pre">--freestanding</span></tt> you are telling the compiler that you intend to run this without relying on an operating system. The could be used, for example, to write an operating system. Alternatively it can be used to access the hardware of a system directly on an embedded system. Doing so you sacrifice things such as memory management, standard IO, thread/process control, etc. Because of this, you can also compile to run on a small RTOS or even an embedded linux system depending on the amount of system resources you have available.</p>
<p>When you use a commercial development platform, you will likely be provided with a cross compiling toolchain and so easy way to run within a small RTOS for example <a class="reference external" href="https://github.com/sifive/freedom-e-sdk">freedom-e-sdk</a>. Alternatively, there are also attempts to make small, but hardware agonistic RTOS see <a class="reference external" href="https://www.zephyrproject.org/">zephyr</a></p>
</div>
<div class="section" id="what-is-risc-v">
<h3><a class="toc-backref" href="#id4">What is RISC-V?</a></h3>
<p>Wikipedia</p>
<blockquote>
RISC-V (pronounced &quot;risk-five&quot;) is an open standard instruction set architecture (ISA) based on established reduced instruction set computer (RISC) principles. Unlike most other ISA designs, the RISC-V ISA is provided under open source licenses that do not require fees to use.</blockquote>
</div>
</div>
<div class="section" id="toolchain-setup">
<h2><a class="toc-backref" href="#id5">Toolchain setup</a></h2>
<p>you can get these from anywhere, but i suggesting compiling from source to ensure we have matching versions. For gcc be aware you have compile the cross-compiling toolchain for rv32i.</p>
<p>There are some compilation prerequisites and gotchas. If my package hints fail, just refer to the official project documentation for each.</p>
<p>To get started, clone my repo, including sub repos:</p>
<div class="highlight"><pre><span></span>git clone --recursive git@github.com:y2kbugger/baremetal-riscv-renode.git
</pre></div>
<p>Install the build requirements, using the hints below if you have trouble. Then build the toolchains:</p>
<div class="highlight"><pre><span></span><span class="nb">cd</span> baremetal-riskv-renode
make toolchains
</pre></div>
<div class="section" id="gcc">
<h3><a class="toc-backref" href="#id6">gcc</a></h3>
<p><a class="reference external" href="https://github.com/riscv/riscv-gnu-toolchain">https://github.com/riscv/riscv-gnu-toolchain</a></p>
<p>Packages I needed on my system</p>
<pre class="code literal-block">
gawk, makeinfo(texinfo package), bison, flex
</pre>
<p>on an ubuntu test system i noticed that if you are missing a curses header, gdb will silently build without the text user interface tui.</p>
<pre class="code literal-block">
libncurses5-dev libncursesw5-dev
</pre>
</div>
<div class="section" id="renode">
<h3><a class="toc-backref" href="#id7">renode</a></h3>
<p><a class="reference external" href="https://renode.readthedocs.io/en/latest/advanced/building_from_sources.html#building-from-source">https://renode.readthedocs.io/en/latest/advanced/building_from_sources.html#building-from-source</a></p>
<p>mono-complete</p>
<ul class="simple">
<li>Arch: i think everything worked fine using the mono package.</li>
<li>Ubuntu: I had inexplicable issues when installing from the standard repos. Following the mono site <a class="reference external" href="https://www.mono-project.com/download/stable/">https://www.mono-project.com/download/stable/</a> worked great.</li>
</ul>
<p>some other misc packages that i needed.</p>
<pre class="code literal-block">
automake autoconf libtool g++ realpath(coreutils on debian) policykit-1 libgtk2.0-dev screen uml-utilities gtk-sharp2 python3
</pre>
</div>
</div>
<div class="section" id="blinking-the-virtual-led">
<h2><a class="toc-backref" href="#id8">Blinking the virtual led</a></h2>
<p>For the first part of this series, we'll cover the minimal viable demo which blinks an LED. This will allow us to get started using renode, gcc riscv cross compiling, and using gdb.</p>
<p>To build and run our first example within renode:</p>
<div class="highlight"><pre><span></span><span class="nb">source</span> activate_toolchains.sh
<span class="nb">cd</span> 1_blinky
make launch
</pre></div>
<p>If everything went correctly, you should see something like this:</p>
<img alt="" src="https://lh3.googleusercontent.com/pw/ACtC-3dKs20yaz1biM2MWXyi7HAcI0pb-BHYDYD1XM92Al11dQPQ26OJY8YULAlHPHtduGETCN5Y5D6aXtkiFi3-9tB3RNtj4A687SGo765evyqri2TjKMCyQeNSLNfZ-SV52yXlIEar9iQj2aEzPKAmBGrQOA=w628-h449-no" />
<p>Todo Explain:</p>
<ul class="simple">
<li>make monitor</li>
<li>make debug</li>
<li>memory mapped hardware registers.</li>
<li>reset vector</li>
</ul>
<p>Program code</p>
<div class="highlight"><pre><span></span><span class="na">.equ</span> <span class="no">LED</span><span class="p">,</span> <span class="mi">0x60000800</span>

<span class="na">.section</span> <span class="no">.text</span>
<span class="na">.global</span> <span class="no">_start</span>

<span class="nl">_start:</span>
        <span class="nf">li</span> <span class="no">a0</span><span class="p">,</span> <span class="mi">0x00</span>
        <span class="nf">li</span> <span class="no">a0</span><span class="p">,</span> <span class="mi">0x00</span>
        <span class="nf">li</span> <span class="no">a3</span><span class="p">,</span> <span class="mi">0x1200000</span>
        <span class="nf">li</span> <span class="no">a5</span><span class="p">,</span> <span class="no">LED</span>
<span class="nl">loop:</span>
        <span class="nf">addi</span> <span class="no">a0</span><span class="p">,</span> <span class="no">a0</span><span class="p">,</span> <span class="mi">0x01</span>
        <span class="nf">bne</span> <span class="no">a0</span><span class="p">,</span> <span class="no">a3</span><span class="p">,</span>  <span class="no">loop</span>

<span class="nl">toggle_led:</span>
        <span class="nf">lw</span> <span class="no">a4</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">(</span><span class="no">a5</span><span class="p">)</span>
        <span class="nf">xori</span> <span class="no">a4</span><span class="p">,</span> <span class="no">a4</span><span class="p">,</span> <span class="mi">0x1</span>
        <span class="nf">sw</span> <span class="no">a4</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">(</span><span class="no">a5</span><span class="p">)</span>
        <span class="nf">jump</span> <span class="no">_start</span><span class="p">,</span> <span class="no">t0</span>
</pre></div>
<p>gdb tui</p>
<img alt="" src="https://lh3.googleusercontent.com/pw/ACtC-3eVGqrh2Gm1lQJKH27cWNYUQO8fVTUAvM1FNZ_pUis0Upip6vEa4ZNGOh79vosxGnBtFcacVX8QRNDgKEeklwFnI9hs6WrAlnzpTDZIyyn1oyTclXxU4_IlzydFbb0UFDkm0CFMsU8f3KIEKY0OWxoPzQ=w354-h710-no" />
</div>
<div class="section" id="miro-samek-and-the-modern-embedded-course-series">
<h2><a class="toc-backref" href="#id9">Miro Samek and the modern embedded course series</a></h2>
<p>I will be loosing cloning MIROS following some of his videos in spirit. He does a great introduction to many concepts in embedded and I want to share that in a way that we don't need to have a real board.</p>
</div>

    </div>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'blog-y2kbugger'; // required: replace example with your forum shortname
        var disqus_identifier = 'drafts/baremetal-riscv-renode-1.html';
        var disqus_url = 'http://blog.y2kbugger.com/drafts/baremetal-riscv-renode-1.html';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </main>

    <footer class="page-footer">
            zak kohler 2020 &mdash; Happy Hacking
    </footer>

</div>
</body>

<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

 -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-111274102-1', 'auto');
  ga('send', 'pageview');
</script>

</html>