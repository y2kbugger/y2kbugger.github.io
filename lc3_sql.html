<!DOCTYPE html>
<html lang="en">
<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <title>LC-3 CPU emulator in pure SQL - blog.y2kbugger.com</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/theme/css/normalize.css">
        <link rel="stylesheet" href="/theme/css/styles.css">
        <link rel="stylesheet" href="/theme/css/pygment.css">
        <link rel="alternate" type="application/atom+xml" href="http://blog.y2kbugger.com/feeds/all.atom.xml" title="All Categories">
        
<link rel="icon" href="/favicon.ico" sizes="16x16 32x32 48x48 64x64" type="image/vnd.microsoft.icon">

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0V39RV6EWP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0V39RV6EWP');
</script>




        <meta name="tags" contents="assembly"/>
        <meta name="tags" contents="algorithms"/>
        <meta name="tags" contents="CPUs"/>
        <meta name="tags" contents="emulation"/>
        <meta name="tags" contents="sql"/>
</head>

<body>


<div id="wrapper">
    <a href="/index.html">
        <img id="logo-image" src="https://lh3.googleusercontent.com/pw/ACtC-3dZJEyHJN3-FqVljZiFt0SZ5xelIGeV8Ka7eKH78bwV-mQAm2_NQiqMboKonLEBfBAXn8PrzqoL7iN9vLy6aO6MQsxkDehaCUxfTxm_DgSCn0ek6oZ4aG4OHat6BY51Y7X4eSBsvUbvi787atMXXAZzzw=w400-h160-no?authuser=0" />
    </a>
    <nav>
        <ul id="menu">
                <li><a href="/tags.html">Tags</a>
                </li>
                        <li><a
                                href="http://blog.y2kbugger.com/category/electronics.html">electronics</a></li>
                        <li><a
                                href="http://blog.y2kbugger.com/category/food.html">food</a></li>
                        <li class="active"><a
                                href="http://blog.y2kbugger.com/category/programming.html">programming</a></li>
                        <li><a
                                href="http://blog.y2kbugger.com/category/talks.html">talks</a></li>
        </ul>
    </nav>
        <div class="social-container">
        <ul>
            <li class="social-item">Find me on:</li>
            <li class="social-item social-twitter"><a href="https://twitter.com/y2kbugger">Twitter @y2kbugger</a></li>
            <li class="social-item social-github"><a href="https://github.com/y2kbugger">GitHub</a></li>
            <li class="social-item social-linkedin"><a href="http://zakkohler.com">LinkedIn</a></li>

            <li class="social-item social-rss"><img class="feed-icon" src="/theme/feed.svg"/><a href="/feeds/all.atom.xml">ATOM Feed</a></li>
        </ul>
    </div>


    <header class="page-header">
    <h1>LC-3 CPU emulator in pure SQL</h1>

    <div class="article-meta">
                <span class="author">By zak kohler</span>
        <span class="publication-date" title="2025-12-26T10:06:02-05:00"> on 2025.12.26 @ 10:06</span>
        <span class="modification-date" title="2026-01-04T18:52:42.862743-05:00"> last modified on 2026.01.04 @ 18:52</span>


            <div class="tags">
                Tagged:
                    <a href="http://blog.y2kbugger.com/tag/assembly.html">assembly</a>,                    <a href="http://blog.y2kbugger.com/tag/algorithms.html">algorithms</a>,                    <a href="http://blog.y2kbugger.com/tag/cpus.html">CPUs</a>,                    <a href="http://blog.y2kbugger.com/tag/emulation.html">emulation</a>,                    <a href="http://blog.y2kbugger.com/tag/sql.html">sql</a>            </div>
    </div>

    </header>

    <main class="content">
    <div class="article-content">
        <p>SQL may be a perverse platform to implement a CPU emulator on, but works well for a demo because all it requires is the SQLite cli binary to run.</p>
<p>A demo program that calculates pi is used to exercise the emulator.</p>
<p><a href="https://gist.github.com/y2kbugger/213912550ab7599e27b56a017bc94ad5">run it yourself</a></p>
<blockquote>
<p><code>time sqlite3 :memory: &lt; PISPIGOT69.sql</code></p>
<p>Output</p>
<div class="highlight"><pre><span></span><code><span class="nv">Runtime</span><span class="w"> </span><span class="nv">error</span><span class="w"> </span><span class="nv">near</span><span class="w"> </span><span class="nv">line</span><span class="w"> </span><span class="mi">1289</span>:<span class="w"> </span><span class="nv">HALT</span><span class="w"> </span><span class="nv">encountered</span><span class="w"> </span><span class="ss">(</span><span class="mi">19</span><span class="ss">)</span>
<span class="nv">Calculated</span><span class="w"> </span><span class="nv">first</span><span class="w"> </span><span class="mi">69</span><span class="w"> </span><span class="nv">digits</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">pi</span>:<span class="w"> </span><span class="mi">314159265358979323846264338327950288419716939937510582097494459230781</span>
<span class="nv">Ran</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mi">8464947</span><span class="w"> </span><span class="nv">clock</span><span class="w"> </span><span class="nv">cycles</span><span class="w"> </span><span class="nv">before</span><span class="w"> </span><span class="nv">halting</span>.

<span class="nv">real</span><span class="w">    </span><span class="mi">0</span><span class="nv">m45</span>.<span class="mi">428</span><span class="nv">s</span>
</code></pre></div>

</blockquote>
<h2>Methodology</h2>
<ol>
<li>The pi spigot algorithm is written in ASM</li>
<li>ASM is assembled to machine code</li>
<li>A harness instantiates the cpu emulator in sql <code>TABLE</code>s and <code>TRIGGER</code>s</li>
<li>The harness loads the machine code into memory table with <code>INSERT</code>s</li>
<li>The cpu is clocked via a recursive cte until <code>HALT</code>ed</li>
<li>Then we can just trace out the db connection to distill to pure sql script.</li>
</ol>
<h2>LC-3 Emulator in SQL</h2>
<p>State is stored in tables. Surprisingly few tables were required, and only <code>register</code> is specific to the LC-3 instruction set.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- inserts here trigger the cpu to step.</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">clkt</span><span class="p">(</span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="nb">INT</span>
<span class="w">    </span><span class="p">);</span>

<span class="c1">-- tracks the halt state and current instruction</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">signal</span><span class="p">(</span>
<span class="w">    </span><span class="n">is_running</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="p">,</span>
<span class="w">    </span><span class="n">instr</span><span class="w"> </span><span class="nb">INT</span>
<span class="w">    </span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">FALSE</span><span class="p">,</span>
<span class="w">    </span><span class="mi">0</span>
<span class="w">    </span><span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">register</span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="nb">INT</span>
<span class="w">    </span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="k">VALUES</span>
<span class="w">    </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w">   </span><span class="c1">-- R0</span>
<span class="w">    </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w">   </span><span class="c1">-- R1</span>
<span class="w">    </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w">   </span><span class="c1">-- R2</span>
<span class="w">    </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w">   </span><span class="c1">-- R3</span>
<span class="w">    </span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w">   </span><span class="c1">-- R4</span>
<span class="w">    </span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w">   </span><span class="c1">-- R5</span>
<span class="w">    </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w">   </span><span class="c1">-- R6</span>
<span class="w">    </span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w">   </span><span class="c1">-- R7</span>
<span class="w">    </span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w">  </span><span class="c1">-- PC</span>
<span class="w">    </span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">-- COND</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">memory</span><span class="p">(</span>
<span class="w">    </span><span class="n">address</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="nb">INT</span>
<span class="w">    </span><span class="p">);</span>

<span class="c1">-- buffers for input and output messages</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">msgout</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">);</span>
</code></pre></div>

<h2>Clocking and instruction loading</h2>
<p>The CPU is clocked by inserting into the <code>clkt</code> table. This fires a trigger. Originally clk was part of the signal table, but separating it out let us trigger on <code>INSERT</code>s rather than <code>UPDATE</code>s, but update required one statement for EVERY clock cycle.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- inserts here trigger the cpu to step.</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">clkt</span><span class="p">(</span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="nb">INT</span>
<span class="w">    </span><span class="p">);</span>

<span class="c1">-- load instructions</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">clk_trigger</span>
<span class="k">AFTER</span><span class="w">  </span><span class="k">INSERT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">clkt</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">signal</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">instr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">))</span>
<span class="w">        </span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>

<span class="c1">-- step Program Counter (PC) register</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">instr_trigger</span>
<span class="k">BEFORE</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">instr</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">signal</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">register</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
</code></pre></div>

<p>My first attempt at clocking was to <code>UPDATE</code> a clock field in the signal table, but that required one statement per clock cycle.</p>
<div class="highlight"><pre><span></span><code><span class="k">UPDATE</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">...</span>
</code></pre></div>

<p>By separating out the clock into its own table, I could <code>INSERT INTO</code> it via a recursive CTE (or the equivalent <a href="https://sqlite.org/series.html"><code>generate_series</code></a>) to clock an arbitrary number of steps in a single statement.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- step n instructions</span>
<span class="k">BEGIN</span><span class="p">;</span>
<span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">clkt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">value</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">8500000</span><span class="p">);</span>
<span class="k">COMMIT</span><span class="p">;</span>
</code></pre></div>

<p>While there is logic to short circuit cycles when <code>HALT</code>ed, it still runs every clkt <code>INSERT</code>, so pick a number just beyond what you expect the program to need.</p>
<h2>Instruction decoding and execution</h2>
<p>All that remains is to decode and execute the instruction that was just loaded into the <code>signal.instr</code> field. To fully implement the LC-3 instruction set, with a handful of <code>TRAP</code>s for I/O, It took about 420 lines of  well spaced triggers.</p>
<h3>System calls</h3>
<p><code>TRAP</code>s aka software interrupts allow interacting with the world.</p>
<p><code>HALT</code> stops the machine</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- ## TRAP x25 (HALT) ##</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">instr_hlt_trigger</span>
<span class="k">AFTER</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">instr</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">signal</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">instr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">xF025</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">is_running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">RAISE</span><span class="p">(</span><span class="n">FAIL</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;HALT encountered&#39;</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
</code></pre></div>

<p><code>PUTS</code> outputs a string.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- ## TRAP x22 (PUTS) ##</span>
<span class="k">DROP</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">instr_puts_trigger</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">instr_puts_trigger</span>
<span class="k">AFTER</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">instr</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">signal</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">instr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">xF022</span>
<span class="k">BEGIN</span>

<span class="w">    </span><span class="c1">-- PUTS implementation: read characters until null terminator</span>
<span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">msgout</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">group_concat</span><span class="p">(</span><span class="nb">char</span><span class="p">(</span><span class="n">value</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;output&#39;</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">value</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">memory</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">          </span><span class="k">AND</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span>
<span class="w">                </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">MIN</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">memory</span>
<span class="w">                 </span><span class="k">WHERE</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                   </span><span class="k">AND</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">                </span><span class="mi">0</span><span class="n">x10000</span><span class="p">)</span><span class="w">  </span><span class="c1">-- if no null terminator, go all the way!</span>
<span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">address</span>
<span class="w">    </span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
</code></pre></div>

<h3>Standard instructions</h3>
<p>There are instructions for arithmetic, logic, memory access, and control flow.</p>
<p>Here is an example of the <code>ADD</code> instruction.</p>
<table>
<thead>
<tr>
<th>Instruction</th>
<th>Operation</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ADD DR, SR1, SR2</code></td>
<td>DR = SR1 + SR2</td>
</tr>
<tr>
<td><code>ADD DR, SR1, imm5</code></td>
<td>DR = SR1 + imm5</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">instr_add_trigger</span>
<span class="k">AFTER</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">instr</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">signal</span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">instr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">xF000</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="n">x1000</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">register</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="k">SELECT</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">instr</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">x7</span><span class="p">)</span><span class="w">  </span><span class="c1">-- SR1</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="k">CASE</span>
<span class="w">                        </span><span class="k">WHEN</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">instr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">x0020</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w">  </span><span class="c1">-- immediate mode (bit 5 set)</span>
<span class="w">                            </span><span class="k">CASE</span>
<span class="w">                                </span><span class="k">WHEN</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">instr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">x0010</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w">  </span><span class="c1">-- sign extend negative imm5</span>
<span class="w">                                    </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">instr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">x001F</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="n">xFFE0</span>
<span class="w">                                </span><span class="k">ELSE</span>
<span class="w">                                    </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">instr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">x001F</span><span class="p">)</span><span class="w">             </span><span class="c1">-- positive imm5 unchanged</span>
<span class="w">                                </span><span class="k">END</span>
<span class="w">                        </span><span class="k">ELSE</span><span class="w">  </span><span class="c1">-- register mode (bit 5 clear)</span>
<span class="w">                            </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NEW</span><span class="p">.</span><span class="n">instr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">x7</span><span class="p">)</span><span class="w">  </span><span class="c1">-- SR2</span>
<span class="w">                        </span><span class="k">END</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">xFFFF</span><span class="w">  </span><span class="c1">-- wrap at 16-bit</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">instr</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">x7</span><span class="p">;</span><span class="w">  </span><span class="c1">-- destination register DR</span>

<span class="w">    </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">register</span>
<span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">CASE</span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">instr</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">x7</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="c1">-- Z</span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="n">instr</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="n">x7</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">15</span><span class="w">  </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">-- P</span>
<span class="w">            </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="c1">-- N</span>
<span class="w">            </span><span class="k">END</span><span class="p">)</span>
<span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
</code></pre></div>

<h2>Loading programs</h2>
<p>Load machine code into memory and reset the CPU registers via <code>INSERT</code>s and <code>UPDATE</code>s.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- ... hundreds before ...</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">12337</span><span class="p">,</span><span class="w"> </span><span class="mi">57929</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">12338</span><span class="p">,</span><span class="w"> </span><span class="mi">21664</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">12339</span><span class="p">,</span><span class="w"> </span><span class="mi">22240</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">12340</span><span class="p">,</span><span class="w"> </span><span class="mi">5878</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">12341</span><span class="p">,</span><span class="w"> </span><span class="mi">6147</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">12342</span><span class="p">,</span><span class="w"> </span><span class="mi">2051</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">12343</span><span class="p">,</span><span class="w"> </span><span class="mi">4099</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">12344</span><span class="p">,</span><span class="w"> </span><span class="mi">5281</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">12345</span><span class="p">,</span><span class="w"> </span><span class="mi">4091</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">12346</span><span class="p">,</span><span class="w"> </span><span class="mi">28736</span><span class="p">);</span>
<span class="c1">-- ... hundreds more ...</span>
<span class="k">BEGIN</span><span class="p">;</span>
<span class="w">    </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">msgout</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;output&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">is_running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="k">COMMIT</span><span class="p">;</span>
<span class="c1">-- now ready to start clocking</span>
</code></pre></div>

<h2>LC-3</h2>
<p>The LC-3 is a simple 16-bit educational CPU architecture often used in computer architecture courses. It has a small instruction set and is designed to be easy to understand.</p>
<ul>
<li>16-bit address space (64KB)</li>
<li>16-bit data words</li>
<li>16-bit instructions</li>
<li>8 general-purpose registers (R0-R7)</li>
</ul>
<p>One reason I chose it because it was the simplest ISA claiming to have a C compiler.</p>
<h3>LC-3 Annoyances</h3>
<p>Toolchains for LC-3 are never battle-tested. Existing implementations of the assemblers, emulators, and the C compilers are buggy. The source code that goes along with the textbooks is often incomplete because they expect you to implement parts of it as exercises.</p>
<p>There was also a lack of verification tests and software to run.</p>
<p>If I had to do it again, I would pick 6502, and I could choose from a plethora of verification ROMs to test against. And there are tons of retro games to port.</p>
<h2>Testing Strategy</h2>
<p>I built a test harness in Python that can compare a reference Python implementation against the SQL implementation.
This actually worked out really well after gathering some programs for integration tests.</p>
<p>The integration tests compared full traces of register state. One day maybe I'll also add memory mutation tracing as well.</p>
<p>The test harness did the heavy lifting of loading programs into memory, stepping the CPU, as well as debugging features such as reading output, providing input, peeking and poking memory and registers, and using asm symbols as breakpoints for testing intermediate states.</p>
<p>See the <a href="https://github.com/y2kbugger/y2k-lc3-tools">lc3_test_harness repo</a></p>
<h2>Interactive Notebooks</h2>
<p>Various interactive notebook tools:</p>
<ul>
<li>Assembling LC-3 assembly to machine code</li>
<li>Disassembling machine code to LC-3 assembly</li>
<li>Running LC-3 machine code in the SQL VM, while graphically debugging registers.</li>
<li>Run and display results of sql snippets against a live LC-3 cpu instance.</li>
<li>E.g. peek at memory, registers, output buffer, etc.</li>
<li>Modifying triggers which implementing instructions on the fly.</li>
</ul>
<h3>Raw SQL notebook magic <code>%%sql</code></h3>
<p><img alt="SQL magic screenshot" src="/img/2025-12-26__lc3_sql__sql_magic_screenshot.png"></p>
<h3>SQLVM widget</h3>
<p><img alt="LC-3 SQL VM interactive widget screenshot" src="/img/2025-12-26__lc3_sql__pispigot_ipynb.apng"></p>
    </div>

    <script src="https://utteranc.es/client.js"
            repo="y2kbugger/y2kbugger.github.io"
            issue-term="pathname"
            label="utterances"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    </main>


    <footer class="page-footer">
            <div class="social-container">
        <ul>
            <li class="social-item">Find me on:</li>
            <li class="social-item social-twitter"><a href="https://twitter.com/y2kbugger">Twitter @y2kbugger</a></li>
            <li class="social-item social-github"><a href="https://github.com/y2kbugger">GitHub</a></li>
            <li class="social-item social-linkedin"><a href="http://zakkohler.com">LinkedIn</a></li>

            <li class="social-item social-rss"><img class="feed-icon" src="/theme/feed.svg"/><a href="/feeds/all.atom.xml">ATOM Feed</a></li>
        </ul>
    </div>

            zak kohler 2026 &mdash; Happy Hacking
    </footer>

</div>
</body>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-111274102-1', 'auto');
  ga('send', 'pageview');
</script>

</html>